<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Letterboxd → Films & Years</title>
  <style>
    :root { --fg:#111; --bg:#fff; --muted:#666; --accent:#0a7; }
    @media (prefers-color-scheme: dark) {
      :root { --fg:#eaeaea; --bg:#0c0c0c; --muted:#9a9a9a; --accent:#4dd; }
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:720px;margin:40px auto;padding:0 16px;}
    h1{font-size:1.4rem;margin:0 0 12px;}
    p.small{color:var(--muted);font-size:.9rem;margin:6px 0 18px;}
    form{display:flex;gap:8px;align-items:center;margin:0 0 16px;}
    input[type=text]{flex:1;min-width:0;padding:10px 12px;border:1px solid #ccc;border-radius:10px;background:transparent;color:var(--fg);}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#003;cursor:pointer;font-weight:600}
    button:disabled{opacity:.6;cursor:not-allowed}
    .error{background:#ffeded;color:#7a1a1a;border:1px solid #f5b5b5;padding:10px 12px;border-radius:10px;margin:10px 0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(127,127,127,.2);text-align:left}
    th{font-size:.9rem;color:var(--muted);font-weight:600}
    .muted{color:var(--muted)}
    .tip{font-size:.85rem;color:var(--muted);margin-top:8px}
    footer{margin-top:28px;color:var(--muted);font-size:.85rem}
    code{background:rgba(127,127,127,.2);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Letterboxd → Films &amp; Years</h1>
    <p class="small">Enter a Letterboxd username to list recent diary entries as <em>Film — Year</em>. All client‑side. No tracking.</p>
    <form id="f">
      <input id="u" type="text" placeholder="e.g. scorsese" autocomplete="on" />
      <button id="go" type="submit">Fetch</button>
    </form>
    <div id="status" class="muted"></div>
    <div id="out"></div>
    <p class="tip">Tip: Diaries must be public. Feeds expose the most recent entries (typically up to 50).</p>
    <footer>
      <div>Built for a minimal static host (GitHub Pages, Vercel, etc.).</div>
    </footer>
  </div>

<script>
const $ = (sel) => document.querySelector(sel);
const statusEl = $("#status");
const outEl = $("#out");
const input = $("#u");
const form = $("#f");
const btn = $("#go");

function normUsername(raw) {
  let u = (raw || "").trim();
  if (!u) return "";
  u = u.replace(/^@/, "");
  u = u.replace(/^https?:\/\/letterboxd\.com\//i, "");
  u = u.replace(/\/.*/, ""); // drop trailing path
  return u;
}

async function fetchTextWithFallback(url) {
  // Try direct fetch first (works if Letterboxd sends CORS headers).
  try {
    const r = await fetch(url, {mode:"cors"});
    if (r.ok) return await r.text();
    throw new Error("HTTP " + r.status);
  } catch (e) {
    // Fallback via public CORS proxy (no guarantees).
    const proxied = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
    const r2 = await fetch(proxied);
    if (r2.ok) return await r2.text();
    throw new Error("Fetch failed (CORS and proxy).");
  }
}

function parseItemsFromRSS(xmlText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, "application/xml");
  // Handle parsererror
  if (doc.querySelector("parsererror")) {
    throw new Error("Unexpected response (not valid RSS/XML).");
  }
  const items = Array.from(doc.querySelectorAll("item"));
  const rows = items.map(item => {
    // Prefer official namespaced tags if present.
    const lbTitle = item.querySelector("letterboxd\\:filmTitle, film\\:filmTitle, filmTitle");
    const lbYear  = item.querySelector("letterboxd\\:filmYear, film\\:filmYear, filmYear");
    let title = lbTitle ? lbTitle.textContent.trim() : "";
    let year  = lbYear ? lbYear.textContent.trim() : "";

    if (!title || !year) {
      // Fallback to item <title> e.g. "Eddie watched Inception (2010) ★★★★"
      const t = (item.querySelector("title")?.textContent || "").trim();
      const m = t.match(/\b([^(]+?)\s*\((\d{4})\)/);
      if (!title && m) title = m[1].trim();
      if (!year && m) year = m[2];
    }
    return title && year ? { title, year } : null;
  }).filter(Boolean);

  return rows;
}

function renderTable(rows, username, source) {
  if (!rows.length) {
    outEl.innerHTML = '<div class="error">No recent public diary entries found for <strong>' + username + '</strong>.</div>';
    return;
  }
  const dedup = new Map(); // title|year -> {title,year}
  for (const r of rows) dedup.set(r.title + "|" + r.year, r);
  const unique = Array.from(dedup.values());

  const head = '<table><thead><tr><th>Film</th><th>Year</th></tr></thead><tbody>';
  const body = unique.map(r => '<tr><td>' + escapeHtml(r.title) + '</td><td>' + escapeHtml(r.year) + '</td></tr>').join("");
  const tail = '</tbody></table>';
  outEl.innerHTML = head + body + tail + '<div class="muted" style="margin-top:8px">Source: ' + source + '</div>';
}

function escapeHtml(s){return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

async function handleSubmit(ev){
  ev.preventDefault();
  const username = normUsername(input.value);
  if(!username){ outEl.innerHTML = '<div class="error">Enter a username.</div>'; return; }
  outEl.innerHTML = "";
  btn.disabled = true;
  statusEl.textContent = "Fetching…";

  const diaryURL = `https://letterboxd.com/${username}/rss/`;
  const filmsURL = `https://letterboxd.com/${username}/films/rss/`;

  // Try diary feed, then films feed.
  let xml = null;
  let used = null;
  try {
    xml = await fetchTextWithFallback(diaryURL);
    used = diaryURL;
  } catch (e1) {
    try {
      xml = await fetchTextWithFallback(filmsURL);
      used = filmsURL;
    } catch (e2) {
      statusEl.textContent = "";
      btn.disabled = false;
      outEl.innerHTML = '<div class="error">Could not fetch RSS for <strong>' + username + '</strong>. The profile may be private or the username invalid.</div>';
      return;
    }
  }

  try {
    const rows = parseItemsFromRSS(xml);
    renderTable(rows, username, used);
    statusEl.textContent = "";
  } catch (err) {
    outEl.innerHTML = '<div class="error">Parsed an unexpected feed format. Try again later.</div>';
  } finally {
    btn.disabled = false;
  }
}

form.addEventListener("submit", handleSubmit);
</script>
</body>
</html>
